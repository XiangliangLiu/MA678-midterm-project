---
title: "Airbnb Mitderm "
author: "Xiangliang Liu"
date: "2018å¹?11æ?o?18æ?-?"
output:
  html_document: default
  pdf_document: default
---
##Abstract

##Introduction
This project will be focusing on the analysis on the relationship betweeen price and rating with other factors on AirBnb website. Airbnb is a privately held global company headquartered in San Francisco that operates an online marketplace and hospitality service which is accessible via its websites and mobile apps. Members can use the service to arrange or offer lodging, primarily homestays, or tourism experiences. The data was extracted from http://tomslee.net, which can also be extracted from official AirBnb website. Specifically, the data was collected from the September 2014 to July 2017 in Boston area. The whole project will consist of following parts "introduction", "Package and data read in", "discussion and visualization", "modeling","conclusion and summary", "reference". I will fitst read in the data and do some visualization to see which predictor will contributes more to the prediction of price and rating.And then the modeling will be conducting multii-level regression using room type and neighborhood as factors to predict price and rating.




### Package and data read in

packages
```{r echo=FALSE, message=FALSE, warning=FALSE}
#install.packages('tinytex')
library(readr)
library(ggplot2)
library(tidyverse)
library(sqldf)
library(knitr)
library(kableExtra)
library(lme4)
library(arm)
```
read in data and combine the them to a whole data set
```{r message=FALSE, echo=FALSE, warning=FALSE}
data1<- read_csv("tomslee_airbnb_boston_0054_2014-09-24.csv")
data2<- read_csv("tomslee_airbnb_boston_0079_2015-01-18.csv")
data3<- read_csv("tomslee_airbnb_boston_0120_2015-07-07.csv")
data4<- read_csv("tomslee_airbnb_boston_0210_2015-11-21.csv")
data5<- read_csv("tomslee_airbnb_boston_0235_2015-12-14.csv")
data6<- read_csv("tomslee_airbnb_boston_0282_2016-01-16.csv")
data7<- read_csv("tomslee_airbnb_boston_0314_2016-02-16.csv")
data8<- read_csv("tomslee_airbnb_boston_0344_2016-03-18.csv")
data9<- read_csv("tomslee_airbnb_boston_0386_2016-04-14.csv")
data10<-read_csv("tomslee_airbnb_boston_0420_2016-05-18.csv")
data11<-read_csv("tomslee_airbnb_boston_0461_2016-06-18.csv")
data12<-read_csv("tomslee_airbnb_boston_0489_2016-07-16.csv")
data13<-read_csv("tomslee_airbnb_boston_0524_2016-08-19.csv")
data14<-read_csv("tomslee_airbnb_boston_0566_2016-09-16.csv")
data15<-read_csv("tomslee_airbnb_boston_0610_2016-10-18.csv")
data16<-read_csv("tomslee_airbnb_boston_0649_2016-11-21.csv")
data17<-read_csv("tomslee_airbnb_boston_0779_2017-01-14.csv")
data18<-read_csv("tomslee_airbnb_boston_0858_2017-02-16.csv")
data19<-read_csv("tomslee_airbnb_boston_0931_2017-03-12.csv")
data20<-read_csv("tomslee_airbnb_boston_1043_2017-04-08.csv")
data21<-read_csv("tomslee_airbnb_boston_1187_2017-05-05.csv")
data22<-read_csv("tomslee_airbnb_boston_1309_2017-06-10.csv")
data23<-read_csv("tomslee_airbnb_boston_1429_2017-07-10.csv")
# There are 23 datasets collected in different period. We used row bind to join all the datasets together. 
total = dplyr::bind_rows(data1,data2,data3, data4, data5, data6, data7, data8, data9,data10,data11, data12, data13, data14, data15, data16,data17, data18, data19,data20, data21,data22, data23)
```

overview of Airbnb data:
```{r}
kable(head(total))
```

##data cleaning
clean the data and specify the variales that will be used in this project.
Specifically,room id, host id room type, neighborhood, number of reviews, overall satisfaction(rating), number of accommodates, number of bedrooms and minimum stay for a visit wil be the potential factors to influence he rating.
```{r}
#specify the column
Airbnb = total[,c(1:3,5:13)]
summary(Airbnb)#check the summary of the data:
#According to the summary we can see there are some missing values in the column of host_id, overvall_statisfaction, accommodates, bedrooms and minstay.
BostonAirbnb = na.omit(Airbnb)#eliminate all the NA value.
```


```{r}
#filter the data with 0 reviews, and 0 price. the observation is meaningless if it has 0 value in number of reviews and price
BostonAirbnb <- BostonAirbnb %>%
  filter(BostonAirbnb$reviews > 0)%>%
  filter(BostonAirbnb$price > 0)
BostonAirbnb$room_id = as.character(BostonAirbnb$room_id)
BostonAirbnb$host_id = as.character(BostonAirbnb$host_id)
length(BostonAirbnb$price)
# the size of cleaned observation is 25513
summary(BostonAirbnb)#Now check the summary of data, There's no missing value in the data and the range of data is reasonable.
```

##Method
###discussion and visualization:
```{r}
#catagorical data:
kable(table(BostonAirbnb$room_type))
kable(table(BostonAirbnb$neighborhood))
```

Distribution of number of reviews
```{r}
hist(BostonAirbnb$reviews, main = "distribution of number of reviews", xlab = "number of review")
```
*as we can see from the distribution plot of number of reviews, most of airbnb hosts have less than 100 reviews.*

Distibution of overall satisfaction:
```{r}
hist(BostonAirbnb$overall_satisfaction, main = "distribution of overall satisfaction", xlab = "overall_satisfaction")
```
*in th histgram plot, most of overall rating is aroud 4.5 and 5. There are also a small portion of people rate the room 4 star. Overall, customers are satisfied with most of rooms in boston area*


Number of room, pricing and average rating with different district:
```{r echo=FALSE}
Rating<-sqldf("SELECT overall_satisfaction, COUNT (room_id) FROM BostonAirbnb Group by 1")
colnames(Rating)<-c("rating","Num_room")
#create a new dataset called district.

district<-sqldf("SELECT neighborhood, COUNT (room_id), Avg(overall_satisfaction),avg(price),avg(reviews), Avg(longitude), Avg(latitude) FROM BostonAirbnb Group by 1")
#rename the column of the dataset.
colnames(district)<-c("district","Num_room", "Avg_rating","Avg_price", "reviews","lon", "lat")

ggplot(data=district, aes(x=reorder(district,-Num_room), y=Num_room))+geom_bar(stat = "identity", fill = "sky blue")+
ggtitle("Number of Airbnb Rooms per District")+ylab("Number of room")+ theme(axis.text.x = element_text(angle = 45, hjust = 1))
```

```{r echo=FALSE}
ggplot(data=district, aes(x=reorder(district,-reviews), y= reviews))+geom_bar(stat = "identity", fill = "sky blue") + ggtitle("Average number of reviews per District")+ylab("Average nmber of reviews") + theme(axis.text.x = element_text(angle = 45, hjust = 1))
```
*From this plot, the district Longwood Medical area has the highest number of review (around 78), while Fenway has the lowest average number of reviews in Boston area(around 15)*
```{r echo=FALSE}
ggplot(data=district, aes(x=reorder(district,-Avg_rating), y= Avg_rating))+geom_bar(stat = "identity", fill = "sky blue") + ggtitle("Average rating of Airbnb Rooms per District")+ylab("Average rating of room") + theme(axis.text.x = element_text(angle = 45, hjust = 1))
#
```
*As the graph showing below, we can't tell significant diffence of rating among different neighborhoods. But we can see Leather District has highest average rating which is close to 5.So neighborhood of the Airbnb room could be an influence predictor. We might want to include this predictor in the model to see whether rating is a significant for predicting price of rooms.*

Average rating and price with different room types.
```{r}
room_type <- sqldf("SELECT room_type, count(room_id), Avg(overall_satisfaction), avg(price) FROM BostonAirbnb Group by 1")
colnames(room_type) = c("room_type","Num_room", "Avg_rating","Avg_price")
ggplot(data = room_type, aes(x= reorder(room_type,-Avg_price),y = Avg_price)) + geom_bar(stat = "identity", fill = "sky blue") + ggtitle("Average price with different room types") + ylab("average price") + theme(axis.text.x = element_text(angle = 45, hjust = 1))
```
*From the plot below we can see entire home/Apt have highest average price among all types of room. This result is reasonable because entire home/apt have more space that can serve more people, so the price is higer.*
```{r}
ggplot(data = BostonAirbnb, aes(overall_satisfaction,fill = room_type)) + geom_bar(position  = "fill") + ggtitle("Average rating with different room types") + ylab("Percentage") + theme(axis.text.x = element_text(angle = 90, hjust = 1))
```
*The the plot showing above indicates the proportion of room types in different score of rating. We can tell from the graph that when overall_satisfaction = 1 share room has relatively larger proportion compared situations when rating equal other values. However, we can't tell that "Entire home/apt" have higher proportion than other room type, because we found in previous EDA that The number of entire home/apt is higher than either private room or shared room.*






The accommodates and bedrooms could be two correlated terms in the model, because the number of bedroom will limit the number of customer served. So the correlation test will be conduted in next step.

```{r}
res <- cor.test(BostonAirbnb$accommodates, BostonAirbnb$bedrooms, 
                    method = "pearson")
res
```
*the p-value of this test is 2.2e-16. So it is signifiacant to say those two variables are highly correlated.*

Before going further, we want to test the distribution of the response variable--price, to test the assumption that it is normal distributed.
```{r}
#create a histgram of the distribution of price from 0 to 
hist(BostonAirbnb1$price, main = "Distribution of room price", xlab = "Price",xlim = c(0,700))
#since the response varible, price is not normal distributed, we are going to do some transformation on this variable.
logprice = log(BostonAirbnb$price)
```


###modelling:

Model1: Simple linear regression:
```{r}
#model1 simple linear regression:
model1 = lm(logprice~ room_type + reviews + overall_satisfaction + accommodates + bedrooms + minstay + factor(neighborhood)-1, data = BostonAirbnb) #We add "-1" to the regression formula to remove the constant term.
display(model1)
AIC(model1)
plot(model1,which = 1)#create a residual plot.
```
From this fundamental model, I found the all of the predictors are significant. Also the R-squre in the model is 0.3, So the model is not well fitted. However, in the residual plot, There are some outlier at point 18772, 2680 and 2487. Those price are very big that lead to huge residuals, we may want to remove those outliers and refit the model.The rest of points are symetrrically distributed around the line h =0.

Model2: Random intercept:
```{r}

#get rid of the outlier:
BostonAirbnb1 = BostonAirbnb[c(-18772, -2680, -2631),]

#now refit the model:
model1.1 = lm(price~ room_type + reviews + overall_satisfaction + accommodates + bedrooms + minstay + factor(neighborhood)-1, data = BostonAirbnb1)
display(model1.1)

model2 = lmer(price ~ room_type + reviews + overall_satisfaction + accommodates + bedrooms + (1|neighborhood), data = BostonAirbnb1)
display(model2)

```

Model3 : Random slope:
```{r}
model3 = lmer(price ~ room_type + reviews + overall_satisfaction + accommodates + bedrooms + (0+ reviews|neighborhood), data = BostonAirbnb1)
display(model3)
#coefplot_my(model3)

```
model4 : Random slope and random intercept.
```{r}
model4 = lmer(price ~ room_type + reviews + overall_satisfaction + accommodates + bedrooms + (1+ reviews|neighborhood), data = BostonAirbnb1)
display(model4)
```
##Result:



##Discussion:


##Reference
http://tomslee.net

##Appendix
```{r}
ggplot(data = room_type, aes(x= reorder(room_type,-Avg_rating),y = Avg_rating)) + geom_bar(stat = "identity", fill = "sky blue") + ggtitle("Average rating with different room types") + ylab("average rating") + theme(axis.text.x = element_text(angle = 45, hjust = 1))
```
* The graph above shows the average rating with different room types. However we can't tell any difference among those three types. This is because the overall rating in Boston area are all very hight(above 4.5).*
